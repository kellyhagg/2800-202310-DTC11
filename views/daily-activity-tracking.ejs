<%- include("templates/header-back", {headerMessage: "Daily Activity Tracking" }) %>

<!-- This is modified from bootstrap's carousel example: https://getbootstrap.com/docs/4.0/components/carousel/ -->

<div class="activity-tracking-page light-green-background">
    <div class="activity-swipe-text text-center light-green-background dark-green">
        Swipe to View Other Activities
    </div>

    <div id="hero-carousel" class="carousel slide w-100 light-green-background activity-tracking-container"
        data-bs-ride="carousel">
        <div class="carousel-inner activity-container">
            <!-- exercise tracking section -->
            <div class="carousel-item active c-item">
                <div class="carousel-background activity-tracking-carousel-background light-green-background"></div>
                <div class="carousel-caption activity-caption top-0 mt-4 dark-green">
                    <h1 class="display-1 fw-bolder text-capitalize">Exercise</h1>
                    <br>
                    <div class="radialprogress exercise-progress-bar"></div>
                    <div class="fs-3 mt-5 " style="font-size: 10px;">
                        <!-- when user reaches their exercise goal -->
                        <% if (isExerciseGoalReached) { %>
                        <p>You have reached your exercise goal today!</p>
                        <% } else { %>
                        <!-- when user has not reached their goal yet -->
                        <p>You are <%= exerciseMinLeft %> minute(s) away from your goal!</p>
                        <% } %>
                    </div>
                    <div>
                        <!-- buttons to add and subtract exercise -->
                        <button class="btn btn-pink-button btn-danger" id="subtractExerciseTime">- 1 mins</button>
                        <button class="btn btn-pink-button btn-danger" id="addExerciseTime">+ 5 mins</button>
                    </div>
                    <div id="Exercise-action-change" class="fs-3 mt-5 dark-pink" style="font-size: 20px;">Exercise: + 0
                        mins
                    </div>
                </div>
            </div>
            <!-- social tracking section -->
            <div class="carousel-item c-item">
                <div class="carousel-background activity-tracking-carousel-background light-green-background"></div>
                <div class="carousel-caption activity-caption top-0 mt-4 dark-green">
                    <p class="display-1 fw-bolder text-capitalize">Social</p>
                    <br>
                    <div class="radialprogress social-progress-bar"></div>
                    <div class="fs-3 mt-5 " style="font-size: 10px;">
                        <!-- when user reaches their social goal -->
                        <% if (isSocialGoalReached) { %>
                        <p>You have reached your social goal today!</p>
                        <% } else { %>
                        <!-- when user has not reached their goal yet -->
                        <p>You are <%= socialMinLeft %> minute(s) away from your goal!</p>
                        <% } %>
                    </div>
                    <div>
                        <!-- buttons to add and subtract social -->
                        <button class="btn btn-pink-button btn-danger" id="subtractSocialTime">- 1 mins</button>
                        <button class="btn btn-pink-button btn-danger" id="addSocialTime">+ 5 mins</button>
                    </div>
                    <div id="Social-action-change" class="fs-3 mt-5 dark-pink" style="font-size: 20px;">Social: + 0 mins
                    </div>
                </div>
            </div>
            <!-- alcohol tracking section -->
            <div class=" carousel-item c-item">
                <div class="carousel-background activity-tracking-carousel-background light-green-background"></div>
                <div class="carousel-caption activity-caption top-0 mt-4 dark-green">
                    <p class="display-1 fw-bolder text-capitalize">Alcohol</p>
                    <br>
                    <div class="radialprogress alcohol-progress-bar"></div>
                    <div class="fs-3 mt-5 " style="font-size: 10px;">
                        <% if (isAlcoholGoalReached) { %>
                        <!-- when user reaches their alcohol limit -->
                        <p>Oh no! You have reached your daily alcohol limit!</p>
                        <% } else { %>
                        <!-- when user has not reached their limit yet -->
                        <p>You have <%= alcoholLeft %> drink(s) left for the day!</p>
                        <% } %>
                    </div>
                    <div>
                        <!-- buttons to add and subtract alcohol -->
                        <button class="btn btn-pink-button btn-danger" id="subtractAlcoholAmount">- 1 drink</button>
                        <button class="btn btn-pink-button btn-danger" id="addAlcoholAmount">+ 1 drink</button>
                    </div>
                    <div id="Alcohol-action-change" class="fs-3 mt-5 dark-pink" style="font-size: 20px;">Alcohol: + 0
                        drink</div>
                </div>
            </div>
            <!-- smoke tracking section -->
            <div class="carousel-item c-item">
                <div class="carousel-background activity-tracking-carousel-background light-green-background"></div>
                <div class="carousel-caption activity-caption top-0 mt-4 dark-green">
                    <p class="display-1 fw-bolder text-capitalize">Smoke</p>
                    <br>
                    <div class="radialprogress smoke-progress-bar"></div>
                    <div class="fs-3 mt-5 " style="font-size: 10px;">
                        <!-- when user reaches their smoke limit -->
                        <% if (isSmokeGoalReached) { %>
                        <p>Oh no! You have reached your daily cigarettes limit!</p>
                        <% } else { %>
                        <!-- when user has not reached their limit yet -->
                        <p>You have <%= smokeLeft %> cigarette(s) left for the day!</p>
                        <% } %>
                    </div>
                    <div>
                        <!-- buttons to add and subtract smoke -->
                        <button class="btn btn-pink-button btn-danger" id="subtractSmokeAmount">- 1 Cigarette</button>
                        <button class="btn btn-pink-button btn-danger" id="addSmokeAmount">+ 1 Cigarette</button>
                    </div>
                    <div id="Smoke-action-change" class="fs-3 mt-5 dark-pink" style="font-size: 20px;">Smoke: + 0
                        Cigarette(s)
                    </div>
                </div>
            </div>
            <!-- buttons to navigate between the slides -->
            <button class="carousel-control-prev" type="button" data-bs-target="#hero-carousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#hero-carousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </div>
    <!-- when users scroll down, they can view and submit their changes -->
    <div class="activity-scroll-down-text text-center light-green-background dark-green">
        Scroll Down to Submit Your Changes
    </div>
    <br>
    <br>
    <br>
    <br>
    <!-- when users scroll up, they can add or subtract their activities -->
    <div class="activity-scroll-up-text text-center light-green-background dark-green">
        Scroll Up to Make Activity Changes
    </div>
    <div id="user-actions" class="activity-swipe-text text-center light-green-background dark-green">
        <div class="activity-confirmation-text">
            <h1>Confirm Your Changes: </h1>
            <br>
            <br>
            <!-- all activity changes made are shown here -->
            <p id="Exercise-action">Exercise: + 0 mins</p>
            <p id="Social-action">Social: + 0 mins</p>
            <p id="Alcohol-action">Alcohol: + 0 drink</p>
            <p id="Smoke-action">Smoke: + 0 cigarette</p>
        </div>
    </div>

    <!-- submit button -->
    <div class="text-center">
        <button class="btn btn btn-lg btn-primary btn-block rounded-pill px-4 py-2 mx-auto"
            style="background-color: #778251; width: 250px; border-color: #778251; font-size: 1.5rem;"
            id="submitActivityChange">Submit</button>
    </div>
</div>

<!-- Include D3 library -->
<script src="https://d3js.org/d3.v3.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

<!-- swiping functions, user can swipe between different activity tracking pages -->
<!-- this code is taken from https://lazcreative.com/blog/adding-swipe-support-to-bootstrap-carousel-3-0/ -->

<script>
    var carousel = document.getElementById('hero-carousel');
    var mc = new Hammer(carousel);

    mc.on('swipeleft', function () {
        $('#hero-carousel').carousel('next');
    });

    mc.on('swiperight', function () {
        $('#hero-carousel').carousel('prev');
    });
</script>


<!-- Script to create progress bar -->
<!-- modified and adapted from code from https://stackoverflow.com/questions/49345858/html-how-do-i-generate-a-progress-bar-circle-with-a-percentage-in-and-set-the by G_S -->
<!-- modification: populate dynamically on different activities, added colours, changed size, changed text, changed progress ratio -->
<script>
    function drawProgress(elementClass, end) {
        var wrapper = d3.select('.' + elementClass);
        var start = 0;

        var colours = {
            fill: '#D88A63', // Finished part color: #D0A449
            track: '#7B8B50', // Unfinished part color: #7B8B50
            text: '#7B8B50', // Text color: #7B8B50
            stroke: '#FFFFFF',
        };

        // set the dimensions and margins of the graph
        var radius = 90;
        var border = 30;
        var strokeSpacing = 4;
        var endAngle = Math.PI * 2;
        var formatText = d3.format('.0%');
        var boxSize = radius * 2;
        var count = end;
        var progress = start;
        var step = end < start ? -0.01 : 0.01;

        // Define the circle
        var circle = d3.svg.arc()
            .startAngle(0)
            .innerRadius(radius)
            .outerRadius(radius - border);

        // Setup SVG wrapper
        var svg = wrapper.append('svg')
            .attr('width', boxSize)
            .attr('height', boxSize);

        // ADD Group container
        var g = svg.append('g')
            .attr('transform', 'translate(' + boxSize / 2 + ',' + boxSize / 2 + ')');

        // Setup track
        var track = g.append('g').attr('class', elementClass);
        track.append('path')
            .attr('fill', colours.track)
            .attr('stroke', colours.stroke)
            .attr('stroke-width', strokeSpacing + 'px')
            .attr('d', circle.endAngle(endAngle));

        // Add color fill for unfinished part
        var unfinished = track.append('path')
            .attr('fill', colours.fill)
            .attr('stroke', colours.stroke)
            .attr('stroke-width', strokeSpacing + 'px');

        // Add color fill for finished part
        var finished = track.append('path')
            .attr('fill', colours.fill)
            .attr('stroke', colours.stroke)
            .attr('stroke-width', strokeSpacing + 'px');

        // Add text value
        var numberText = track.append('text')
            .attr('class', 'value-text')
            .attr('fill', colours.text)
            .attr('text-anchor', 'middle')
            .attr('dy', '1.2rem')
            .style('font-size', '27px');

        // Update position of endAngle for unfinished part
        unfinished.attr('d', circle.endAngle(endAngle * start));

        // Update position of endAngle for finished part
        finished.attr('d', circle.endAngle(endAngle * end));

        // Update text value
        numberText.text(formatText(end));
    }
</script>

<script>
    // Note: this warning does not affect functionality, and can be ignored (confirmed with supervisor)
    // eslint-disable-next-line
    drawProgress('exercise-progress-bar', <%= exerciseProgressRatio %>);
    // eslint-disable-next-line
    drawProgress('social-progress-bar', <%= socialProgressRatio %>);
    // eslint-disable-next-line
    drawProgress('alcohol-progress-bar', <%= alcoholProgressRatio %>);
    // eslint-disable-next-line
    drawProgress('smoke-progress-bar', <%= smokeProgressRatio %>);
</script>

<script>
    // Variables to store user action durations
    var exerciseDuration = 0;
    var socialDuration = 0;
    var alcoholAmount = 0;
    var smokeAmount = 0;

    // Function to update the user action duration in the div
    function updateActionDuration(action, duration) {
        // Update the user action duration in the div
        // When duration is negative, it means the user has subtracted time
        if (duration.startsWith('-')) {
            $('#' + action + '-action').text(action + ': ' + duration);
            $('#' + action + '-action-change').text(action + ': ' + duration);

            // When duration is positive, it means the user has added time
        } else {
            $('#' + action + '-action').text(action + ': +' + duration);
            $('#' + action + '-action-change').text(action + ': +' + duration);
        }
    }

    // Button click event handlers
    // subtract and add exercise time
    $('#subtractExerciseTime').click(function () {
        exerciseDuration -= 1;
        // triggers warning when user tries to subtract more than 0
        if (exerciseDuration < 0) {
            alert('Warning: Exercise duration cannot be negative');
            exerciseDuration = 0;
        }
        updateActionDuration('Exercise', exerciseDuration + ' mins');
    });

    $('#addExerciseTime').click(function () {
        exerciseDuration += 5;
        updateActionDuration('Exercise', exerciseDuration + ' mins');
    });

    // subtract and add social time
    $('#subtractSocialTime').click(function () {
        socialDuration -= 1;
        // triggers warning when user tries to subtract more than 0
        if (socialDuration < 0) {
            alert('Warning: Social duration cannot be negative');
            socialDuration = 0;
        }
        updateActionDuration('Social', socialDuration + ' mins');
    });

    $('#addSocialTime').click(function () {
        socialDuration += 5;
        updateActionDuration('Social', socialDuration + ' mins');
    });

    // subtract and add alcohol amount
    $('#subtractAlcoholAmount').click(function () {
        alcoholAmount -= 1;
        // triggers warning when user tries to subtract more than 0
        if (alcoholAmount < 0) {
            alert('Warning: Alcohol amount cannot be negative');
            alcoholAmount = 0;
        }
        updateActionDuration('Alcohol', alcoholAmount + ' drink(s)');
    });

    $('#addAlcoholAmount').click(function () {
        alcoholAmount += 1;
        updateActionDuration('Alcohol', alcoholAmount + ' drink(s)');
    });

    // subtract and add smoke amount
    $('#subtractSmokeAmount').click(function () {
        smokeAmount -= 1;
        // triggers warning when user tries to subtract more than 0
        if (smokeAmount < 0) {
            alert('Warning: Smoke amount cannot be negative');
            smokeAmount = 0;
        }
        updateActionDuration('Smoke', smokeAmount + ' Cigarette(s)');
    });

    $('#addSmokeAmount').click(function () {
        smokeAmount += 1;
        updateActionDuration('Smoke', smokeAmount + ' Cigarette(s)');
    });
</script>

<script>
    // written with assistance of chatGPT
    // Function to handle the submit button click event
    $('#submitActivityChange').click(function () {
        // Extract the numbers from the text content of the <p> elements
        var exerciseDurationText = $('#Exercise-action').text();
        var socialDurationText = $('#Social-action').text();
        var alcoholAmountText = $('#Alcohol-action').text();
        var smokeAmountText = $('#Smoke-action').text();

        // parse the numbers from the text content, including negative sign
        var exerciseDuration = parseFloat(exerciseDurationText.match(/-?\d+/)[0]);
        var socialDuration = parseFloat(socialDurationText.match(/-?\d+/)[0]);
        var alcoholAmount = parseFloat(alcoholAmountText.match(/-?\d+/)[0]);
        var smokeAmount = parseFloat(smokeAmountText.match(/-?\d+/)[0]);


        // Create an object with the data to be sent in the request
        var data = {
            exerciseDuration: exerciseDuration,
            socialDuration: socialDuration,
            alcoholAmount: alcoholAmount,
            smokeAmount: smokeAmount
        };

        // Make the POST request using jQuery's $.post method
        $.post('/daily-activity-tracking', data, function (response) {
            // Handle the response from the server if needed
            console.log(response);

            // Reload the page after submitting changes
            window.location.href = window.location.href;
        })
            .done(function () {
                // if the request is successful
                console.log('POST request successful');
            })
            .fail(function () {
                // if the request fails
                console.log('POST request failed');
            });
    });

</script>



<%- include("templates/footer") %>